<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BeiDou Satellite Tracker</title>
  <!-- CesiumJS and satellite.js libraries -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.1.4/satellite.min.js"></script>
  <style>
    /* Basic layout */
    html, body, #cesiumContainer {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif;
    }
    /* Satellite selection list */
    #satList {
      position: absolute; top: 10px; left: 10px; background: rgba(42, 42, 42, 0.9);
      color: white; padding: 10px; border-radius: 6px; max-height: 80%; overflow-y: auto; z-index: 10;
    }
    #satList label { display: block; font-size: 13px; margin-bottom: 4px; cursor: pointer; }
    #satList input[type="checkbox"] { margin-right: 6px; }
    /* Control buttons */
    #controls {
      position: absolute; top: 10px; right: 10px; background: rgba(42, 42, 42, 0.9);
      color: white; padding: 10px; border-radius: 6px; z-index: 10;
    }
    #controls button {
      margin: 3px 0; display: block; width: 100%; padding: 8px; background: #555;
      border: none; color: white; cursor: pointer; border-radius: 4px;
    }
    #controls button:hover { background: #777; }
    /* Legend Box */
    #legend {
        position: absolute; bottom: 30px; left: 10px; background: rgba(42, 42, 42, 0.9);
        color: white; padding: 10px; border-radius: 6px; z-index: 10; font-size: 14px;
    }
    #legend .color-box {
        display: inline-block; width: 12px; height: 12px; margin-right: 8px;
        vertical-align: middle; border: 1px solid #fff;
    }
    #legend .yellow { background-color: yellow; }
    #legend .green { background-color: green; }
    #legend .purple { background-color: purple; }
    #legend div { margin-top: 5px; }
    /* Navigation Instructions */
    #instructions {
        position: absolute; bottom: 10px; left: 50%;
        transform: translateX(-50%); /* Horizontally center the element */
        background: rgba(42, 42, 42, 0.8); color: white;
        padding: 8px 15px; border-radius: 6px; z-index: 10;
        font-size: 13px; text-align: center; white-space: nowrap;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="satList"><strong>BeiDou Satellites</strong></div>
  <div id="controls">
    <button onclick="selectAll(true)">Select All</button>
    <button onclick="selectAll(false)">Clear All</button>
  </div>
  <!-- Legend container -->
  <div id="legend"></div>
  <!-- Instructions container -->
  <div id="instructions"></div>

  <script>
    // Initialize Cesium viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      shouldAnimate: true, timeline: true, animation: true,
      baseLayerPicker: false, infoBox: false
    });

    // Hide the default globe to show our custom entity
    viewer.scene.globe.show = false;

    // Custom Earth representation
    const earthEntity = viewer.entities.add({
      name: 'Earth', position: Cesium.Cartesian3.ZERO,
      ellipsoid: {
        radii: new Cesium.Cartesian3(6371000, 6371000, 6371000),
        material: Cesium.Color.DIMGRAY.withAlpha(0.9),
        outline: true, outlineColor: Cesium.Color.WHITE, outlineWidth: 2
      }
    });

    const now = Cesium.JulianDate.now();
    const orbitSeconds = 12 * 3600;
    const step = 60;
    const entityMap = {};

    async function fetchBeiDouTLEs() {
      try {
        const response = await fetch("https://celestrak.org/NORAD/elements/gp.php?GROUP=beidou&FORMAT=tle");
        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
        const text = await response.text();
        const lines = text.trim().split('\n');
        const tleList = [];
        for (let i = 0; i < lines.length; i += 3) {
          if (i + 2 < lines.length) {
            tleList.push({ name: lines[i].trim(), tle1: lines[i+1].trim(), tle2: lines[i+2].trim() });
          }
        }
        return tleList;
      } catch (error) {
        console.error('Error fetching TLE data:', error);
        return []; // Return empty on error
      }
    }

    function createOrbitEntities(satrec, name, color) {
      const positionProp = new Cesium.SampledPositionProperty();
      for (let i = -orbitSeconds / 2; i <= orbitSeconds / 2; i += step) {
        const time = Cesium.JulianDate.addSeconds(now, i, new Cesium.JulianDate());
        try {
          const pv = satellite.propagate(satrec, Cesium.JulianDate.toDate(time));
          if (pv.position) {
            const gmst = satellite.gstime(Cesium.JulianDate.toDate(time));
            const ecf = satellite.eciToEcf(pv.position, gmst);
            const pos = new Cesium.Cartesian3(ecf.x * 1000, ecf.y * 1000, ecf.z * 1000);
            positionProp.addSample(time, pos);
          }
        } catch (error) { /* Ignore propagation errors */ }
      }
      if (positionProp.numberOfSamples === 0) return null;

      const orbitEntity = viewer.entities.add({
        id: name + '_orbit', name, position: positionProp,
        point: { pixelSize: 5, color },
        path: { resolution: 120, material: color, width: 2, leadTime: orbitSeconds / 2, trailTime: orbitSeconds / 2 }
      });

      const currentDot = viewer.entities.add({
        id: name + '_dot', name: name + " â€¢ Now",
        position: new Cesium.CallbackProperty(() => {
          try {
            const pv = satellite.propagate(satrec, Cesium.JulianDate.toDate(viewer.clock.currentTime));
            const gmst = satellite.gstime(Cesium.JulianDate.toDate(viewer.clock.currentTime));
            const ecf = satellite.eciToEcf(pv.position, gmst);
            return new Cesium.Cartesian3(ecf.x * 1000, ecf.y * 1000, ecf.z * 1000);
          } catch (e) { return null; }
        }, false),
        point: { pixelSize: 8, color: Cesium.Color.RED }
      });

      return [orbitEntity, currentDot];
    }

    function selectAll(flag) {
      Object.values(entityMap).forEach(([orbit, dot], idx) => {
        if (orbit && dot) {
          orbit.show = flag; dot.show = flag;
          const checkbox = document.querySelectorAll('#satList input')[idx];
          if (checkbox) checkbox.checked = flag;
        }
      });
    }

    function updateLegend(count) {
        const legendDiv = document.getElementById('legend');
        legendDiv.innerHTML = `
            <div><span class="color-box yellow"></span><b>Yellow:</b> Satellites in Near or Medium Earth Orbit</div>
            <div><span class="color-box green"></span><b>Green:</b> Geo Stationary Satellites</div>
            <div><span class="color-box purple"></span><b>Purple:</b> Satellites in geo synchronize orbit</div>
            <hr style="border-color: #555;">
            <div><strong>Total Satellites: ${count}</strong></div>
        `;
    }

    async function init() {
      const tleData = await fetchBeiDouTLEs();
      if (!tleData.length) {
        console.error('No TLE data available.');
        updateLegend(0);
        return;
      }

      const satListDiv = document.getElementById("satList");
      tleData.forEach((sat) => {
        try {
          const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);
          const satName = sat.name.toUpperCase();
          let color;

          if (satName.includes('IGSO')) {
            color = Cesium.Color.PURPLE;
          } else if (satName.includes(' G')) {
            color = Cesium.Color.GREEN;
          } else if (satName.includes(' M')) {
            color = Cesium.Color.YELLOW;
          } else {
            color = Cesium.Color.BLUE; // Default for others
          }

          const entities = createOrbitEntities(satrec, sat.name, color);
          if (entities) {
            entityMap[sat.name] = entities;
            const [orbit, dot] = entities;
            const cb = document.createElement("input");
            cb.type = "checkbox"; cb.checked = true;
            cb.onchange = () => { orbit.show = cb.checked; dot.show = cb.checked; };
            const label = document.createElement("label");
            label.appendChild(cb);
            label.appendChild(document.createTextNode(sat.name));
            satListDiv.appendChild(label);
          }
        } catch (error) {
          console.warn(`Error processing satellite ${sat.name}:`, error);
        }
      });

      // Update the legend and navigation instructions
      updateLegend(Object.keys(entityMap).length);
      document.getElementById('instructions').innerHTML = '<b>Navigate:</b> Left-click to Pan | Right-click/Scroll to Zoom | SHIFT + Click to Rotate';

      // Set the viewer clock
      viewer.clock.currentTime = now.clone();
      viewer.clock.shouldAnimate = true;

      // Automatically fly to a view that encompasses all satellites
      viewer.flyTo(viewer.entities, {
          duration: 4, // Animate camera over 4 seconds
          offset: new Cesium.HeadingPitchRange(0, -Cesium.Math.PI_OVER_TWO * 0.5, 0)
      });
    }

    init().catch(error => console.error('Initialization failed:', error));
  </script>
</body>
</html>```
